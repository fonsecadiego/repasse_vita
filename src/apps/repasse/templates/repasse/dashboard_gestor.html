{% extends "repasse/base.html" %}
{% block title %}Dashboard Gestor{% endblock %}
{% block content %}
<h1>Dashboard do Gestor</h1>
<p>Competência {{ mes|stringformat:"02d" }}/{{ ano }}</p>

<div class="card">
    <form method="get" class="form-grid">
        <div class="field"><label>Ano</label><input name="ano" value="{{ filtros.ano }}"></div>
        <div class="field"><label>Mês</label><input name="mes" value="{{ filtros.mes }}"></div>
        <div class="field"><label>Unidade</label><input list="opt-unidade" name="unidade" value="{{ filtros.unidade }}"></div>
        <div class="field"><label>Convênio</label><input list="opt-convenio" name="convenio" value="{{ filtros.convenio }}"></div>
        <div class="field"><label>Escala</label><input list="opt-escala" name="escala" value="{{ filtros.escala }}"></div>
        <div class="field"><label>Leitura</label><input list="opt-leitura" name="leitura" value="{{ filtros.leitura }}"></div>
        <div class="field"><label>Tipo Procedimento</label><input list="opt-tipo" name="tipo_proced" value="{{ filtros.tipo_proced }}"></div>
        <div class="field"><label>Procedimento</label><input list="opt-proced" name="procedimento" value="{{ filtros.procedimento }}"></div>
    </form>
    <div style="margin-top:12px;">
        <button class="btn" onclick="this.closest('.card').querySelector('form').submit()">Aplicar filtros</button>
        <a class="btn btn-secondary" href="?ano={{ filtros.ano }}&mes={{ filtros.mes }}">Limpar filtros</a>
    </div>
    <datalist id="opt-unidade">{% for v in options.unidade %}<option value="{{ v }}">{% endfor %}</datalist>
    <datalist id="opt-convenio">{% for v in options.convenio %}<option value="{{ v }}">{% endfor %}</datalist>
    <datalist id="opt-escala">{% for v in options.escala %}<option value="{{ v }}">{% endfor %}</datalist>
    <datalist id="opt-leitura">{% for v in options.leitura %}<option value="{{ v }}">{% endfor %}</datalist>
    <datalist id="opt-tipo">{% for v in options.tipo_proced %}<option value="{{ v }}">{% endfor %}</datalist>
    <datalist id="opt-proced">{% for v in options.procedimento %}<option value="{{ v }}">{% endfor %}</datalist>
</div>

<div class="card">
    <h3>Resumo</h3>
    <p>Total médicos: {{ totais_por_medico|length }} | Total itens: {{ breakdown|length }}</p>
</div>

<div class="card">
    <h3>Totais por médico</h3>
    <table><thead><tr><th>Médico</th><th>Exames</th><th>Repasse</th></tr></thead><tbody>
    {% for row in totais_por_medico %}<tr><td>{{ row.medico__nome|default:"-" }}</td><td>{{ row.total_exames }}</td><td>R$ {{ row.total_repasse|default:"0.00" }}</td></tr>{% empty %}<tr><td colspan="3">Sem dados.</td></tr>{% endfor %}
    </tbody></table>
</div>

<div class="card">
    <h3>Detalhamento</h3>
    <table><thead><tr><th>Médico</th><th>Data</th><th>Procedimento</th><th>Convênio</th><th>Qtd</th><th>Repasse</th></tr></thead><tbody>
    {% for item in breakdown %}<tr><td>{{ item.medico__nome|default:"-" }}</td><td>{{ item.dt_laudo }}</td><td>{{ item.ds_proced }}</td><td>{{ item.convenio }}</td><td>{{ item.quantidade }}</td><td>R$ {{ item.repasse_calculado|default:"0.00" }}</td></tr>{% empty %}<tr><td colspan="6">Sem itens.</td></tr>{% endfor %}
    </tbody></table>
</div>
{% endblock %}
